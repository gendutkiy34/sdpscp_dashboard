SELECT CDRDATE,SERVICE_KEY,IS_ROAMING,ISBFT,DIAMETER,SUM(TOTAL) as TOTAL
FROM
(SELECT to_char(CDR_TIMESTAMP,'yyyy-mm-dd HH24')  AS CDRDATE,SERVICE_KEY,IS_ROAMING,ISBFT,DIAMETER_RESULT_CODES AS DIAMETER,COUNT(TRANSACTION_ID) AS total
FROM SCPCDR.INTERNAL_CDR_{day}
WHERE M_MONTH= '{mon}' AND  to_char(CDR_TIMESTAMP,'HH24:MI') < '{hourmin}'
GROUP BY to_char(CDR_TIMESTAMP,'yyyy-mm-dd HH24'),SERVICE_KEY,IS_ROAMING,ISBFT,DIAMETER_RESULT_CODES
UNION ALL
SELECT to_char(CDR_TIMESTAMP,'yyyy-mm-dd HH24') AS CDRDATE,SERVICE_KEY,IS_ROAMING,ISBFT,DIAMETER_RESULT_CODES AS DIAMETER,COUNT(TRANSACTION_ID) AS total
FROM SCPCDR.INTERNAL_CDR_{day}@scpcdr_prod_pk_public
WHERE M_MONTH= '{mon}' AND  to_char(CDR_TIMESTAMP,'HH24:MI') < '{hourmin}'
GROUP BY to_char(CDR_TIMESTAMP,'yyyy-mm-dd HH24'),SERVICE_KEY,IS_ROAMING,ISBFT,DIAMETER_RESULT_CODES )
GROUP BY CDRDATE,SERVICE_KEY,IS_ROAMING,ISBFT,DIAMETER
ORDER BY CDRDATE,SERVICE_KEY,DIAMETER